<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Puppet Show Ticket Registration</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Load Firebase/Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = null;
        let isAuthReady = false;

        // Set up Firebase and Auth Listener
        window.initFirebase = async () => {
            try {
                // Set Firestore log level to Debug for visibility
                setLogLevel('Debug');
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db; // Make DB available globally for the main script

                // EXPOSED Firestore FUNCTIONS: Make collection, query, where, etc. available to the main script block
                window.collection = collection;
                window.query = query;
                window.where = where;
                window.getDocs = getDocs;
                window.addDoc = addDoc;
                window.onSnapshot = onSnapshot;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        // Sign in anonymously if no custom token is provided
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    if (user || !initialAuthToken) { // Ready when user is signed in or anonymous sign-in failed/skipped
                        currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                        isAuthReady = true;
                        window.setupListeners(currentUserId);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-message').textContent = 'Error initializing system. Check console for details.';
            }
        };

        // Utility function to retry Firestore operations with exponential backoff
        window.retryWithBackoff = async (operation, maxRetries = 5, delay = 1000) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    // 7 = 'PERMISSION_DENIED', 8 = 'RESOURCE_EXHAUSTED' (for rate limiting)
                    if (error.code && (error.code === 'permission-denied' || error.code === 'resource-exhausted')) {
                        console.warn(`Firestore operation failed (attempt ${i + 1}/${maxRetries}): ${error.message}. Retrying in ${delay / 1000}s...`);
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                        } else {
                            throw new Error(`System Overloaded or Permission Denied: Could not complete registration after ${maxRetries} attempts. Please try again later.`);
                        }
                    } else {
                        // Throw other errors immediately
                        throw error;
                    }
                }
            }
        };
        
        window.initFirebase();
    </script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        .backdrop {
            background-image: url('https://livingnomads.com/wp-content/uploads/2017/03/30/hue-water-puppet-show-1068x801.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        .overlay {
            background-color: rgba(0, 0, 0, 0.7); /* Dark overlay for better text contrast */
        }
        .styled-title {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            line-height: 1.1;
        }
        .counter-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="backdrop min-h-screen">
    <div class="overlay min-h-screen p-4 md:p-8 flex items-center justify-center">

        <!-- Main Container -->
        <div id="app-container" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 transition-all duration-500">
            
            <!-- Loading/Time Check Screen -->
            <div id="initial-check-screen" class="text-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
                <p id="loading-message" class="text-xl text-gray-700">Checking system status and time limit...</p>
                <p class="text-sm text-gray-500 mt-2">Current User ID: <span id="user-id-display" class="font-mono text-xs">Loading...</span></p>
                <p id="overload-tip" class="text-red-500 font-semibold mt-4 hidden">
                    ⚠️ System Overload Tip: If you face frequent 'System Overloaded' errors, please wait 5-10 minutes and try again when fewer students are accessing the site simultaneously.
                </p>
            </div>

            <!-- Registration Form Screen -->
            <div id="registration-screen" class="hidden">
                <div class="text-center text-white p-4 -mx-6 -mt-10 md:-mx-10 rounded-t-xl" style="background-color: #3b82f6;">
                    <h1 class="styled-title text-4xl sm:text-5xl font-extrabold mb-1">
                        Water Puppet Show:
                    </h1>
                    <h1 class="styled-title text-4xl sm:text-5xl font-extrabold">
                        The Legend of Yết Kiêu
                    </h1>
                </div>

                <p class="text-center text-gray-700 mt-4 italic">
                    The story of one of the five brilliant generals of King Trần Hưng Đạo.
                </p>

                <!-- Event Details -->
                <div class="mt-6 border-t pt-4">
                    <h2 class="text-2xl font-bold text-red-600 mb-3">Event Information</h2>
                    <dl class="text-gray-700 space-y-2">
                        <div class="flex flex-col sm:flex-row">
                            <dt class="font-semibold w-full sm:w-1/3">Organizer:</dt>
                            <dd class="w-full sm:w-2/3">Nguyen Khuyen High School English Dept. in collaboration with HCMC Art Center</dd>
                        </div>
                        <div class="flex flex-col sm:flex-row">
                            <dt class="font-semibold w-full sm:w-1/3">Location:</dt>
                            <dd class="w-full sm:w-2/3">Water Puppet Stage – No. 2 Nguyen Binh Khiem, HCMC (Inside the History Museum)</dd>
                        </div>
                        <div class="flex flex-col sm:flex-row">
                            <dt class="font-semibold w-full sm:w-1/3">Time:</dt>
                            <dd class="w-full sm:w-2/3 text-lg font-bold text-blue-700">October 18, 2025</dd>
                        </div>
                        <div class="flex flex-col sm:flex-row">
                            <dt class="font-semibold w-full sm:w-1/3">Ticket Price:</dt>
                            <dd class="w-full sm:w-2/3 font-bold text-red-600">80,000 VND/ticket</dd>
                        </div>
                    </dl>

                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                        <h3 class="font-bold text-yellow-800">Important Notes:</h3>
                        <ul class="list-disc list-inside text-sm text-gray-700 space-y-1 mt-1">
                            <li>This special water puppet show is <b>exclusive</b> for <b>10th-grade students</b> of Nguyen Khuyen High School.</li>
                            <li>The registration link will close at <b>11:00 PM on October 7, 2025</b>, or when <b>130 seats/session</b> are full.</li>
                            <li>Each student can register for <b>1 ticket only</b>.</li>
                            <li>Payment (80,000 VND) will be collected after the final list is announced.</li>
                        </ul>
                    </div>
                </div>

                <!-- Registration Form -->
                <form id="registration-form" class="mt-8 space-y-6">
                    <h2 class="text-2xl font-bold text-blue-600">Registration Information</h2>
                    
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="fullName" name="fullName" required 
                               placeholder="e.g., Nguyen Van A"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p id="name-error" class="text-red-500 text-xs mt-1 hidden">Invalid name format. Please enter a meaningful name.</p>
                    </div>

                    <div>
                        <label for="class" class="block text-sm font-medium text-gray-700">Class</label>
                        <input type="text" id="class" name="class" required 
                               placeholder="e.g., 10A1 or 10B2 (Must start with '10')"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 uppercase">
                        <p id="class-error" class="text-red-500 text-xs mt-1 hidden">Class must start with '10' (e.g., 10A1).</p>
                    </div>

                    <!-- Session Selection -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Select a Session (1 ticket per student)</h3>
                        <div class="space-y-3">
                            <!-- Session 1 -->
                            <label class="flex items-center p-3 border rounded-lg shadow-sm cursor-pointer hover:bg-blue-50 transition-colors">
                                <input type="radio" name="session" value="Session 1: 8:00 AM - 9:00 AM" class="form-radio h-4 w-4 text-blue-600" required>
                                <span class="ml-3 text-gray-900 font-medium">Session 1: 8:00 AM - 9:00 AM</span>
                                <div class="ml-auto text-sm text-right">
                                    <p class="font-bold text-green-600" id="count-1">Loading...</p>
                                </div>
                            </label>
                            <!-- Session 2 -->
                            <label class="flex items-center p-3 border rounded-lg shadow-sm cursor-pointer hover:bg-blue-50 transition-colors">
                                <input type="radio" name="session" value="Session 2: 1:00 PM - 2:00 PM" class="form-radio h-4 w-4 text-blue-600" required>
                                <span class="ml-3 text-gray-900 font-medium">Session 2: 1:00 PM - 2:00 PM</span>
                                <div class="ml-auto text-sm text-right">
                                    <p class="font-bold text-green-600" id="count-2">Loading...</p>
                                </div>
                            </label>
                            <!-- Session 3 -->
                            <label class="flex items-center p-3 border rounded-lg shadow-sm cursor-pointer hover:bg-blue-50 transition-colors">
                                <input type="radio" name="session" value="Session 3: 4:00 PM - 5:00 PM" class="form-radio h-4 w-4 text-blue-600" required>
                                <span class="ml-3 text-gray-900 font-medium">Session 3: 4:00 PM - 5:00 PM</span>
                                <div class="ml-auto text-sm text-right">
                                    <p class="font-bold text-green-600" id="count-3">Loading...</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div id="duplicate-error" class="text-center bg-red-100 border border-red-400 text-red-700 p-3 rounded hidden">
                        <b>Error:</b> Registration failed. A ticket has already been registered for this Name and Class combination. Each student can only register once.
                    </div>
                    
                    <div id="general-error" class="text-center bg-red-100 border border-red-400 text-red-700 p-3 rounded hidden">
                        <b>Error:</b> An unexpected error occurred. Check the console or try again later.
                    </div>

                    <button type="submit" id="submit-button"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out disabled:opacity-50"
                            disabled>
                        Register Ticket
                    </button>
                </form>
            </div>

            <!-- Success Screen -->
            <div id="success-screen" class="hidden text-center py-10">
                <img src="https://newsmd2fr.keeng.vn/tiin/archive/imageslead/2024/12/24/6ljali0161btgdnu4mq8w9wkyiacshg7.jpg" 
                     alt="Joyful congratulations image" 
                     class="mx-auto w-32 h-32 md:w-48 md:h-48 rounded-full shadow-lg object-cover mb-6 border-4 border-green-500">
                
                <h2 class="text-3xl md:text-4xl font-extrabold text-green-700 mb-4">
                    🎉 Registration Successful! 🎉
                </h2>

                <div class="bg-green-50 p-6 rounded-lg border border-green-300 mx-auto max-w-md">
                    <p class="text-lg text-gray-800 mb-4">
                        Dear <span id="success-name" class="font-bold text-blue-600"></span>,
                    </p>
                    <p class="text-lg text-gray-800 mb-4">
                        You have successfully registered for the Water Puppet Show.
                    </p>
                    
                    <div class="text-left space-y-2 mb-6">
                        <p class="font-semibold">Class: <span id="success-class" class="text-red-500"></span></p>
                        <p class="font-semibold">Selected Session: <span id="success-session" class="text-red-500"></span></p>
                    </div>

                    <p class="text-red-600 font-bold text-xl mb-4">
                        Please prepare 80,000 VND for payment.
                    </p>
                    <p class="text-sm text-gray-600">
                        A final official list and payment collection details will be announced later.
                    </p>
                </div>

                <p class="mt-6 text-sm text-gray-500">Thank you for your interest!</p>
            </div>

        </div>
    </div>

    <script type="module">
        // Import necessary components from the global scope set up in the first script tag
        const { db, retryWithBackoff, collection, query, where, getDocs, addDoc, onSnapshot } = window; 
        
        // ** ĐƯỜNG DẪN WEB APP APPS SCRIPT ĐÃ TRIỂN KHAI CỦA BẠN **
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzMgRd7aZSteqXhd0FT57ABEIcdBqlNNcv68FFEB6Ii_6FF6IQMTI9ScOJ2FGk8yyeN/exec';

        const MAX_CAPACITY = 130;
        const OPENING_TIME = new Date("2025-10-05T10:40:00+07:00"); // 10:40 AM, Oct 5, 2025 HCMC time
        const CLOSING_TIME = new Date("2025-10-07T23:00:00+07:00"); // 11:00 PM, Oct 7, 2025 HCMC time
        const SESSION_MAP = {
            'Session 1: 8:00 AM - 9:00 AM': 'Session 1',
            'Session 2: 1:00 PM - 2:00 PM': 'Session 2',
            'Session 3: 4:00 PM - 5:00 PM': 'Session 3',
        };
        const sessionCounts = {
            'Session 1': 0,
            'Session 2': 0,
            'Session 3': 0,
        };

        let isFormOpen = false;
        let isRegistrationActive = false;
        
        const registrationScreen = document.getElementById('registration-screen');
        const initialCheckScreen = document.getElementById('initial-check-screen');
        const loadingMessage = document.getElementById('loading-message');
        const overloadTip = document.getElementById('overload-tip');
        const submitButton = document.getElementById('submit-button');
        const registrationForm = document.getElementById('registration-form');
        const successScreen = document.getElementById('success-screen');
        const classInput = document.getElementById('class');
        const fullNameInput = document.getElementById('fullName');
        const nameError = document.getElementById('name-error');
        const classError = document.getElementById('class-error');
        const duplicateError = document.getElementById('duplicate-error');
        const generalError = document.getElementById('general-error');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Utility Functions ---

        // Function to format the name (Capitalize first letter of each word)
        const formatName = (str) => {
            return str.toLowerCase().split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ').trim();
        };

        // Function to check for meaningless concatenated characters
        const isValidName = (name) => {
            // Check for general length and non-empty words
            if (name.trim().length < 3) return false;

            // Regex to check for non-stop repeating characters (e.g., 'aaaaa', '11111') or keyboard-walks (e.g., 'asdfghjkl')
            // This is a simple defense. Real-world validation would be more complex.
            const repeatedChars = /(.)\1{3,}/i; // 4 or more of the same char
            const keyboardWalk = /(asdf|qwerty|zxcv|dfgh|hjkl|jkl;)/i; // common bad patterns

            if (repeatedChars.test(name) || keyboardWalk.test(name.toLowerCase())) {
                return false;
            }

            // Simple check: Must contain at least one space (for Full Name)
            if (!name.includes(' ')) {
                return false;
            }

            return true;
        };

        // Function to check form state and toggle submit button
        const checkFormState = () => {
            const isNameValid = isValidName(fullNameInput.value);
            const isClassValid = classInput.value.trim().toUpperCase().startsWith('10');
            const isSessionSelected = registrationForm.querySelector('input[name="session"]:checked');

            nameError.classList.toggle('hidden', isNameValid || fullNameInput.value.length === 0);
            classError.classList.toggle('hidden', isClassValid || classInput.value.length === 0);

            submitButton.disabled = !(isFormOpen && isNameValid && isClassValid && isSessionSelected);
            
            // Check for capacity limit
            if (isSessionSelected) {
                const sessionKey = SESSION_MAP[isSessionSelected.value];
                if (sessionCounts[sessionKey] >= MAX_CAPACITY) {
                    submitButton.textContent = `Session ${sessionKey.slice(-1)} is FULL`;
                    submitButton.disabled = true;
                } else {
                    submitButton.textContent = 'Register Ticket';
                    submitButton.disabled = !(isFormOpen && isNameValid && isClassValid);
                }
            } else {
                submitButton.textContent = 'Register Ticket';
            }
        };

        fullNameInput.addEventListener('input', checkFormState);
        classInput.addEventListener('input', checkFormState);
        document.querySelectorAll('input[name="session"]').forEach(radio => radio.addEventListener('change', checkFormState));


        // --- Time Check and UI Toggling ---

        const checkTimeAndToggleUI = () => {
            const now = new Date();
            const timeDiffOpen = OPENING_TIME.getTime() - now.getTime();
            const timeDiffClose = CLOSING_TIME.getTime() - now.getTime();

            if (timeDiffOpen > 0) {
                // Form is not yet open
                isFormOpen = false;
                loadingMessage.innerHTML = `Registration opens on <b>${OPENING_TIME.toLocaleString('en-US')}</b>. Please wait.`;
                submitButton.textContent = 'Registration Not Yet Open';
                submitButton.disabled = true;

                // Set a timer to re-check when it should open
                setTimeout(checkTimeAndToggleUI, timeDiffOpen + 100);
            } else if (timeDiffClose < 0) {
                // Form is closed
                isFormOpen = false;
                loadingMessage.innerHTML = `Registration is <b>CLOSED</b> since ${CLOSING_TIME.toLocaleString('en-US')}.`;
                submitButton.textContent = 'Registration Closed';
                submitButton.disabled = true;
            } else {
                // Form is open and active
                isFormOpen = true;
                initialCheckScreen.classList.add('hidden');
                registrationScreen.classList.remove('hidden');
                submitButton.disabled = false;
                isRegistrationActive = true;
                checkFormState();
            }
        };


        // --- Firestore Setup and Handlers ---

        window.setupListeners = (userId) => {
            userIdDisplay.textContent = userId;
            
            if (!db) {
                loadingMessage.textContent = 'Database connection failed.';
                return;
            }

            // Collection path for public data: /artifacts/{appId}/public/data/water_puppet_registrations
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/public/data/water_puppet_registrations`;
            const registrationsCollection = collection(db, collectionPath);
            
            // 1. Start the time check loop after auth is ready
            checkTimeAndToggleUI();

            // 2. Set up real-time listener for ticket counts
            onSnapshot(registrationsCollection, (snapshot) => {
                const currentCounts = { 'Session 1': 0, 'Session 2': 0, 'Session 3': 0 };
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.sessionKey) {
                        currentCounts[data.sessionKey]++;
                    }
                });

                Object.assign(sessionCounts, currentCounts);
                
                // Update UI counters and check form state
                ['1', '2', '3'].forEach(i => {
                    const sessionKey = `Session ${i}`;
                    const count = sessionCounts[sessionKey];
                    const remaining = MAX_CAPACITY - count;
                    const countEl = document.getElementById(`count-${i}`);
                    
                    if (remaining <= 0) {
                        countEl.innerHTML = `<span class="text-red-600 font-extrabold">FULL (${count}/${MAX_CAPACITY})</span>`;
                        // Visually disable the radio button if full
                        document.querySelector(`input[value="${Object.keys(SESSION_MAP).find(k => SESSION_MAP[k] === sessionKey)}"]`).disabled = true;
                    } else {
                        countEl.innerHTML = `Remaining: <span class="font-extrabold">${remaining}</span> / ${MAX_CAPACITY}`;
                         document.querySelector(`input[value="${Object.keys(SESSION_MAP).find(k => SESSION_MAP[k] === sessionKey)}"]`).disabled = false;
                        if (remaining <= 10) {
                            countEl.classList.add('text-orange-500');
                            countEl.classList.remove('text-green-600');
                        } else {
                            countEl.classList.add('text-green-600');
                            countEl.classList.remove('text-orange-500');
                        }
                    }
                });
                checkFormState(); // Re-check button state after capacity update
            }, (error) => {
                console.error("Error setting up snapshot listener:", error);
                loadingMessage.textContent = 'Error loading ticket data. Try reloading.';
            });
        };
        
        // Gửi dữ liệu đăng ký đến Apps Script Web App để ghi vào Google Sheet
        const logToGoogleSheet = async (data) => {
            if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE') {
                console.warn("Apps Script URL is not configured. Skipping logging to Google Sheet.");
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Cần thiết để Apps Script Web App chấp nhận request
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Lưu ý: Do sử dụng 'no-cors', chúng ta không thể đọc body JSON trả về.
                // Chúng ta chỉ có thể kiểm tra xem fetch có bị lỗi mạng không.
                if (!response.ok && response.type !== 'opaque') {
                     // Nếu có lỗi HTTP (không phải lỗi network/no-cors), chúng ta vẫn in ra warning
                     console.warn(`Warning: Could not confirm Google Sheet log status. HTTP Status: ${response.status}`);
                }
                
                console.log("Data sent to Google Sheet endpoint.");

            } catch (error) {
                console.error("Error logging data to Google Sheet endpoint (Network/CORS issue expected with 'no-cors' mode):", error);
                // Dù có lỗi log, chúng ta vẫn coi đăng ký thành công nếu đã lưu vào Firestore
            }
        }


        // --- Registration Submission Handler ---

        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            duplicateError.classList.add('hidden');
            generalError.classList.add('hidden');
            
            if (!isRegistrationActive) return;

            submitButton.disabled = true;
            submitButton.textContent = 'Registering... Please Wait';
            overloadTip.classList.add('hidden');

            const rawName = fullNameInput.value.trim();
            const rawClass = classInput.value.trim();
            const selectedSessionText = registrationForm.querySelector('input[name="session"]:checked')?.value;
            
            if (!isValidName(rawName) || !rawClass.toUpperCase().startsWith('10') || !selectedSessionText) {
                submitButton.disabled = false;
                submitButton.textContent = 'Register Ticket';
                return;
            }
            
            // Auto-formatting for saving
            const formattedName = formatName(rawName);
            const formattedClass = rawClass.toUpperCase();
            const sessionKey = SESSION_MAP[selectedSessionText];

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/public/data/water_puppet_registrations`;
            
            try {
                // 1. CHECK FOR DUPLICATE (Name + Class)
                const checkDuplicateOperation = async () => {
                    const q = query(
                        collection(db, collectionPath),
                        where("formattedName", "==", formattedName),
                        where("formattedClass", "==", formattedClass)
                    );
                    const querySnapshot = await getDocs(q);
                    return querySnapshot.empty; // Returns true if no duplicate found
                };

                const isUnique = await retryWithBackoff(checkDuplicateOperation);

                if (!isUnique) {
                    duplicateError.classList.remove('hidden');
                    return;
                }
                
                // 2. CHECK CAPACITY AGAIN (in case another user registered since the last snapshot update)
                if (sessionCounts[sessionKey] >= MAX_CAPACITY) {
                    generalError.textContent = 'Error: The selected session just became full. Please choose another one.';
                    generalError.classList.remove('hidden');
                    return;
                }

                // 3. REGISTER to Firestore AND LOG to Google Sheet
                const registrationData = {
                    rawName: rawName,
                    rawClass: rawClass,
                    formattedName: formattedName, // Saved for filtering/display
                    formattedClass: formattedClass, // Saved for filtering/display
                    selectedSessionText: selectedSessionText,
                    sessionKey: sessionKey, // Saved for counting
                    timestamp: new Date().toISOString(),
                    userId: window.currentUserId, // Store for potential tracking
                };

                const registerOperation = () => addDoc(collection(db, collectionPath), registrationData);
                await retryWithBackoff(registerOperation);
                
                // LOG TO GOOGLE SHEET (Asynchronously, after successful Firestore registration)
                logToGoogleSheet(registrationData);


                // 4. SHOW SUCCESS SCREEN
                document.getElementById('success-name').textContent = formattedName;
                document.getElementById('success-class').textContent = formattedClass;
                document.getElementById('success-session').textContent = selectedSessionText;
                
                registrationScreen.classList.add('hidden');
                successScreen.classList.remove('hidden');

            } catch (error) {
                console.error("Registration failed:", error);
                overloadTip.classList.remove('hidden');
                
                let errorMessage = 'An unexpected error occurred.';
                if (error.message.includes('System Overloaded')) {
                    errorMessage = error.message + ' Please try again later.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'Registration denied. Please contact the organizer.';
                }
                
                generalError.innerHTML = `<b>Error:</b> ${errorMessage}`;
                generalError.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Register Ticket';
                checkFormState();
            }
        });

        // Initialize Firebase will call window.setupListeners once auth is ready
        if (typeof window.initFirebase === 'function') {
            // Note: initFirebase is called in the first script tag
            // If the environment does not define __firebase_config, we start the check immediately
            if (!window.firebaseConfig || Object.keys(window.firebaseConfig).length === 0) {
                 window.setupListeners(crypto.randomUUID());
            }
        } else {
             // Fallback if the module imports fail (shouldn't happen)
             loadingMessage.textContent = 'System Initialization Error.';
        }
    </script>
</body>
</html>

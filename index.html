<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Puppet Show Registration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: #f0f4f8;
            /* Background Image visible */
            background-image: url('https://livingnomads.com/wp-content/uploads/2017/03/30/hue-water-puppet-show-1068x801.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        
        .container-card {
            /* Tăng chiều ngang form */
            max-width: 570px; 
            margin: 2rem auto; 
            padding: 2.5rem; 
            background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white for readability */
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
            border: 3px solid #065f46; 
        }
        .title-large {
            font-size: 2.5rem;
            line-height: 1.1;
        }
        /* Custom styles for the message box */
        .message-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 300px;
            text-align: center;
        }
        .message-box.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }
        .radio-label {
            transition: all 0.2s;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .radio-label:has(input:not([disabled]):hover) {
            background-color: #f0fdf4;
        }
        .radio-label:has(input:checked) {
            border-color: #059669;
            background-color: #d1fae5;
            box-shadow: 0 0 0 2px #34d399;
        }
        .submit-enabled {
            background-color: #059669 !important;
            box-shadow: 0 8px 15px rgba(5, 150, 105, 0.4);
        }
        .submit-enabled:hover {
            background-color: #047857 !important;
        }
        .capitalize-name {
            text-transform: capitalize;
        }
        /* Đã giảm kích thước tối thiểu cho đếm ngược */
        .countdown-timer {
            font-size: 1rem; 
            font-weight: 900;
            color: #ef4444; /* Red color for urgency */
            text-shadow: 0 0 5px rgba(239, 68, 68, 0.4);
            letter-spacing: 0.5px; 
            margin-top: 0.5rem;
            /* Đảm bảo không bị xuống hàng */
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Ensure responsiveness on small screens */
        @media (max-width: 640px) {
            .container-card {
                max-width: 95%;
                margin: 1rem auto;
                padding: 1.5rem;
            }
            .title-large {
                font-size: 2rem;
            }
            .countdown-timer {
                font-size: 0.875rem; /* Tương đương text-sm cho mobile */
                letter-spacing: 0.2px;
            }
        }
    </style>
</head>
<body>

    <!-- Message Box for Alerts -->
    <div id="message-box" class="message-box"></div>

    <!-- Main Registration Card -->
    <div id="main-card-container" class="container-card">
        
        <!-- --- CONTENT SECTION (TO BE HIDDEN ON SUCCESS) --- -->
        <div id="registration-content">
            <!-- Title -->
            <h1 class="title-large font-extrabold text-center text-gray-900 mb-2">
                Water Puppet Show: <br><span class="text-emerald-600">Legend of Yết Kiêu</span>
            </h1>
            <p class="text-sm text-center text-gray-600 mb-6 italic">
                The story of one of Hưng Đạo Vương's five most talented generals.
            </p>
            
            <!-- Event Details -->
            <div class="bg-gray-50 p-5 rounded-xl mb-6 border border-gray-200 shadow-inner">
                <h3 class="font-bold text-lg text-gray-800 mb-3 border-b pb-1">Event Information</h3>
                <ul class="space-y-2 text-sm">
                    <li class="grid grid-cols-4 gap-2"><span class="font-bold text-gray-700 col-span-1">Organizers:</span> <span class="col-span-3 text-gray-600">Nguyen Khuyen English Dept. & HCMC Art Center</span></li>
                    <li class="grid grid-cols-4 gap-2"><span class="font-bold text-gray-700 col-span-1">Location:</span> <span class="col-span-3 text-gray-600">Water Puppet Stage – No. 2 Nguyen Binh Khiem, HCMC (Inside the History Museum)</span></li>
                    <li class="grid grid-cols-4 gap-2"><span class="font-bold text-gray-700 col-span-1">Time:</span> <span class="col-span-3 text-gray-800 font-bold">October 18, 2025</span></li>
                    <li class="grid grid-cols-4 gap-2"><span class="font-bold text-gray-700 col-span-1">Ticket Price:</span> <span class="col-span-3 text-red-500 font-extrabold">80,000 VND/ticket</span></li>
                </ul>
            </div>

            <!-- Important Notice -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg mb-6 text-sm">
                <ul class="list-disc list-inside space-y-1 text-yellow-800">
                    <li><span class="font-bold">Note:</span> This special show is exclusive to <span class="font-bold">Grade 10</span> students of Nguyen Khuyen High School.</li>
                    <li>The link will close at <span class="font-bold">23:00 on Oct 07, 2025</span> or when <span class="font-bold">130 seats/session</span> are fully booked.</li>
                    <li>Each student may register for <span class="font-bold">1 ticket only.</span></li>
                </ul>
            </div>

            <!-- Session Availability Status -->
            <div id="status-section" class="mb-6">
                <h3 class="font-bold text-xl text-gray-700 mb-3 border-b pb-1">Session Availability Status</h3>
                <div id="session-stats" class="space-y-3 text-base">
                    <p class="text-gray-500 text-center">Loading status...</p>
                </div>
                <!-- Vị trí mới cho trạng thái mở form -->
                <p id="form-open-status" class="mt-4 text-lg font-extrabold text-center text-gray-700"></p>
                <!-- Đồng hồ đếm ngược (đã làm nhỏ) -->
                <p id="countdown-timer" class="countdown-timer text-center hidden"></p>
            </div>

            <!-- Registration Form -->
            <form id="registration-form" class="space-y-5">
                <h3 class="font-bold text-xl text-gray-700 mb-3 border-b pb-1">Registration Information</h3>
                
                <!-- Full Name -->
                <div>
                    <label for="full-name" class="block text-sm font-bold text-gray-700">Full Name:</label>
                    <input type="text" id="full-name" name="fullName" required placeholder="Nguyen Van A" 
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 ease-in-out capitalize-name">
                    <p class="text-xs text-gray-500 mt-1">First letter of each word will be automatically capitalized on submission.</p>
                </div>

                <!-- Class -->
                <div>
                    <label for="class" class="block text-sm font-bold text-gray-700">Class:</label>
                    <input type="text" id="class" name="class" required placeholder="10A1" 
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 ease-in-out">
                    <p class="text-xs text-gray-500 mt-1 text-red-500 font-semibold">Only Grade 10 students are allowed to register (must start with "10").</p>
                </div>

                <!-- Session Selection -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3">Select Show Session (1 ticket only):</label>
                    <div id="session-options" class="space-y-3">
                        <!-- Options loaded by JS -->
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button id="submit-button" type="submit" disabled
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-bold text-white bg-gray-400 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-emerald-300 transition duration-300 ease-in-out">
                    REGISTER TICKET
                </button>
                <div id="loading-spinner" class="text-center hidden">
                    <svg class="animate-spin h-6 w-6 text-emerald-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-sm text-gray-500 mt-2">Processing registration...</p>
                </div>
            </form>
        </div>
        <!-- --- END CONTENT SECTION --- -->


        <!-- Success Screen (Initially hidden) -->
        <div id="success-screen" class="hidden text-center p-8 bg-green-50 border-2 border-green-300 rounded-lg shadow-xl">
            <!-- Success Image -->
            <img id="success-image" src="https://newsmd2fr.keeng.vn/tiin/archive/imageslead/2024/12/24/6ljali0161btgdnu4mq8w9wkyiacshg7.jpg" 
                onerror="this.onerror=null;this.src='https://placehold.co/150x150/d1fae5/065f46?text=Success';"
                class="h-32 w-32 object-cover rounded-full mx-auto mb-4 border-4 border-white shadow-md" alt="Success">

            <h3 class="text-3xl font-bold text-green-700 mb-3">REGISTRATION SUCCESSFUL!</h3>
            <!-- Updated to include Class -->
            <p class="text-gray-700 text-lg mb-2">Congratulations, <span id="success-name" class="font-extrabold text-emerald-600"></span> (<span id="success-class" class="font-extrabold text-blue-600"></span>)!</p>
            <p class="text-gray-700 text-lg mb-4">You have successfully reserved one ticket for the <span id="success-session" class="font-extrabold text-emerald-600"></span> session.</p>
            
            <div class="bg-yellow-100 p-3 rounded-lg border border-yellow-300 mt-4">
                <p class="text-sm text-yellow-900 font-medium">
                    Please wait for the official final list announcement.
                    Prepare <span class="font-bold text-red-600">80,000 VND</span> for ticket payment.
                </p>
            </div>
            
            <!-- Student cannot return to registration page -->
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- CONFIGURATION ---
        // !!! BƯỚC 1: THAY THẾ CHÍNH XÁC URL ĐÃ TRIỂN KHAI CỦA BẠN VÀO ĐÂY !!!
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbx2viRyUGtBAKr2zi-gb7F50HGjVBIWwQIETMY9LbrT2AyMcVK3b4WeZZUbCCY9YePA/exec'; 
        const MAX_CAPACITY_PER_SESSION = 130;
        const MAX_RETRIES = 3;
        
        // --- CẤU HÌNH QUAN TRỌNG: Đang ở chế độ chạy THẬT. ---
        const IS_MOCKING_STATUS = false; 
        
        // --- MOCK CONFIGURATION (CHỈ DÙNG KHI IS_MOCKING_STATUS = TRUE) ---
        const now = new Date();
        const MOCK_START_TIME = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 11, 30, 0).getTime();
        const MOCK_CLOSE_TIME = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 11, 45, 0).getTime();
        // ------------------------------------------------------------------
        
        // --- DOM Elements ---
        const form = document.getElementById('registration-form');
        const submitButton = document.getElementById('submit-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const sessionOptionsDiv = document.getElementById('session-options');
        const sessionStatsDiv = document.getElementById('session-stats');
        const formOpenStatusEl = document.getElementById('form-open-status');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const successScreen = document.getElementById('success-screen');
        const messageBox = document.getElementById('message-box');
        const registrationContent = document.getElementById('registration-content');
        
        // Input fields (needed to read class value)
        const classInput = document.getElementById('class');

        let countdownInterval = null; // Biến để lưu trữ interval của đồng hồ đếm ngược

        // --- Utility Functions ---

        /**
         * Utility function to display custom messages (replaces alert()).
         */
        function displayMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`;

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000); 
        }

        /**
         * Utility function to attempt fetching with exponential backoff and retry logic.
         */
        async function attemptFetch(url, options, retries = 0) {
            try {
                // Kiểm tra nếu GAS_URL chưa được thay thế
                if (url.includes('YOUR_DEPLOYED_GOOGLE_APPS_SCRIPT_URL_HERE')) {
                    throw new Error("ERROR: The Google Apps Script URL has not been replaced. Please update the GAS_URL variable in the code.");
                }
                
                const response = await fetch(url, options);
                
                if (response.ok || response.status < 500) {
                    return response;
                }

                throw new Error(`Server responded with status: ${response.status}`);

            } catch (error) {
                console.error('Fetch attempt failed:', error.message);
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + (Math.random() * 500);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return attemptFetch(url, options, retries + 1);
                }
                // Thông báo lỗi chung sau khi đã retry
                throw new Error('Connection failed after multiple retries. Please check your network or verify the Google Apps Script URL and permissions.');
            }
        }
        
        /**
         * Formats timestamp into a readable localized time string.
         */
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', { 
                month: 'short', day: '2-digit', year: 'numeric', 
                hour: '2-digit', minute: '2-digit', hour12: true
            });
        }

        /**
         * Translates session names to display times.
         */
        function getSessionTime(session) {
            if (session === 'Session 1') return '8:00 AM - 9:00 AM';
            if (session === 'Session 2') return '1:00 PM - 2:00 PM';
            if (session === 'Session 3') return '4:00 PM - 5:00 PM';
            return '';
        }

        /**
         * Cập nhật đồng hồ đếm ngược
         * @param {number} targetTime - Thời gian mục tiêu (milliseconds)
         */
        function updateCountdown(targetTime) {
            const now = new Date().getTime();
            const distance = targetTime - now;

            if (distance < 0) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                countdownTimerEl.classList.add('hidden');
                // Tải lại trạng thái form ngay khi đếm ngược kết thúc
                fetchStats(); 
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            
            // Định dạng dd:hh:mm
            const countdownText = `Form opens in: ${String(days).padStart(2, '0')} days : ${String(hours).padStart(2, '0')} hours : ${String(minutes).padStart(2, '0')} minutes`;
            countdownTimerEl.textContent = countdownText;
            countdownTimerEl.classList.remove('hidden');
        }

        /**
         * Xử lý hiển thị đồng hồ đếm ngược và trạng thái form.
         * @param {string} formStatus - Trạng thái của form (NOT_OPEN, OPEN, CLOSED)
         * @param {number} startTime - Thời gian mở form (milliseconds)
         * @param {number} closeTime - Thời gian đóng form (milliseconds)
         */
        function handleFormStatusDisplay(formStatus, startTime, closeTime) {
            // Xóa đồng hồ đếm ngược cũ nếu có
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            countdownTimerEl.classList.add('hidden');
            
            // Xử lý trạng thái mới
            if (formStatus === 'NOT_OPEN') {
                formOpenStatusEl.innerHTML = `
                    <span class="text-red-600 font-extrabold block mb-1">REGISTRATION IS NOT OPEN YET.</span>
                `;
                submitButton.disabled = true;
                
                // Bắt đầu đếm ngược đến giờ mở
                updateCountdown(startTime);
                // Cập nhật đồng hồ mỗi 60 giây (chỉ hiển thị phút), trừ khi còn dưới 1 phút thì cập nhật mỗi giây
                const intervalDuration = (startTime - new Date().getTime() < 60000) ? 1000 : 60000;
                countdownInterval = setInterval(() => updateCountdown(startTime), intervalDuration); 
                
            } else if (formStatus === 'CLOSED') {
                formOpenStatusEl.innerHTML = `<span class="text-red-600 font-extrabold block">REGISTRATION CLOSED.</span> <span class="text-sm font-normal block">The deadline was ${formatTime(closeTime)} or all tickets were sold.</span>`;
                submitButton.disabled = true;
            } else { // OPEN
                formOpenStatusEl.innerHTML = `<span class="text-green-600 font-extrabold block">REGISTRATION IS OPEN!</span> <span class="text-sm font-normal block">Closes at ${formatTime(closeTime)}.</span>`;
                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400');
                submitButton.classList.add('submit-enabled');
            }

            // Nếu form đang mở hoặc đóng, đảm bảo nút submit có trạng thái đúng
            if (formStatus !== 'OPEN') {
                submitButton.classList.remove('submit-enabled');
                submitButton.classList.add('bg-gray-400');
            }
        }


        /**
         * Fetches and updates registration statistics and form state.
         */
        async function fetchStats() {
            sessionStatsDiv.innerHTML = '<p class="text-gray-500 text-center">Loading status...</p>';
            formOpenStatusEl.textContent = 'Checking form status...';
            submitButton.disabled = true;
            submitButton.classList.remove('submit-enabled');
            submitButton.classList.add('bg-gray-400');
            
            let result;

            if (IS_MOCKING_STATUS) {
                // --- MOCK LOGIC: (DISABLED) ---
                const currentTime = new Date().getTime();
                let formStatus;

                if (currentTime < MOCK_START_TIME) {
                    formStatus = 'NOT_OPEN';
                } else if (currentTime >= MOCK_START_TIME && currentTime <= MOCK_CLOSE_TIME) {
                    formStatus = 'OPEN';
                } else {
                    formStatus = 'CLOSED';
                }
                
                // Giả lập dữ liệu thống kê (để kiểm tra trạng thái đầy/chưa đầy)
                const stats = [
                    { session: 'Session 1', registered: 120 }, // Gần đầy
                    { session: 'Session 2', registered: 50 },  // Vẫn còn nhiều
                    { session: 'Session 3', registered: 130 }  // Đã đầy (FULL)
                ];

                result = {
                    status: 'success',
                    stats: stats,
                    formStatus: formStatus,
                    startTime: MOCK_START_TIME,
                    closeTime: MOCK_CLOSE_TIME
                };
                
                // Giả lập độ trễ mạng
                await new Promise(resolve => setTimeout(resolve, 500)); 
                // --- END MOCK LOGIC ---

            } else {
                // --- REAL LOGIC: Lấy dữ liệu thực từ Google Apps Script ---
                try {
                    const url = `${GAS_URL}?action=getStats`;
                    const response = await attemptFetch(url, { method: 'GET' });
                    result = await response.json();
                } catch (error) {
                    // Nếu gặp lỗi mạng/kết nối, hiển thị thông báo
                    console.error("Lỗi khi fetch Stats:", error);
                    displayMessage(error.message, 'error');
                    formOpenStatusEl.textContent = 'Network or server connection error. Check console for details.';
                    return; // Thoát nếu lỗi
                }
                // --- END REAL LOGIC ---
            }

            // Bắt đầu xử lý dữ liệu (Áp dụng chung cho cả MOCK và REAL)
            if (result.status === 'success') {
                const { stats, formStatus, startTime, closeTime } = result;
                
                // 1. Xử lý trạng thái mở form và đồng hồ đếm ngược
                handleFormStatusDisplay(formStatus, startTime, closeTime);
                
                // 2. Cập nhật thống kê phiên và Tùy chọn Radio
                sessionStatsDiv.innerHTML = '';
                sessionOptionsDiv.innerHTML = '';

                stats.forEach(sessionStat => {
                    const remaining = MAX_CAPACITY_PER_SESSION - sessionStat.registered;
                    const isFull = remaining <= 0;
                    const sessionTime = getSessionTime(sessionStat.session);
                    
                    // Hiển thị Thống kê
                    sessionStatsDiv.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-xl border border-emerald-200 shadow-sm">
                            <span class="font-semibold text-gray-800">${sessionStat.session} (${sessionTime})</span>
                            <div class="text-right">
                                <span class="text-lg font-extrabold ${isFull ? 'text-red-600' : 'text-emerald-600'}">
                                    ${Math.max(0, remaining)} / ${MAX_CAPACITY_PER_SESSION}
                                </span>
                                <p class="text-xs text-gray-500">Registered: ${sessionStat.registered}</p>
                            </div>
                        </div>
                    `;

                    // Tạo Tùy chọn Radio
                    // Chỉ cho phép đăng ký nếu form đang MỞ VÀ phiên chưa đầy
                    const isDisabled = isFull || formStatus !== 'OPEN';
                    const statusText = isFull ? '— FULLY BOOKED' : '';
                    
                    sessionOptionsDiv.innerHTML += `
                        <label class="radio-label block p-3 border border-gray-300 ${isDisabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'cursor-pointer'}">
                            <input type="radio" name="session" value="${sessionStat.session}" 
                                   class="text-emerald-600 focus:ring-emerald-500" ${isDisabled ? 'disabled' : ''}>
                            <span class="ml-3 font-semibold">${sessionStat.session} (${sessionTime}) <span class="text-red-500 text-xs font-bold">${statusText}</span></span>
                        </label>
                    `;
                });

            } else {
                // Lỗi từ phản hồi của Server/GAS
                const details = result.message || "Unknown error from Apps Script. Check its logs.";
                displayMessage(`Server Error: ${details}`, 'error');
                formOpenStatusEl.textContent = 'Error loading form status. Server response failed.';
            }

        }
        
        /**
         * Handles form submission for ticket registration.
         */
        async function handleSubmit(e) {
            e.preventDefault();
            
            // Client-side validation: Class must start with '10'
            const className = classInput.value.trim();
            if (!className.toUpperCase().startsWith('10')) {
                displayMessage("Error: This event is exclusive to Grade 10 students. Your Class must start with '10'.", 'error');
                return;
            }

            // Client-side validation: Basic name check
            const fullName = document.getElementById('full-name').value.trim();
            if (/(.)\1{3,}/.test(fullName) || fullName.length < 5) {
                 displayMessage("Error: Please enter a valid full name.", 'error');
                 return;
            }


            const formData = new FormData(form);
            formData.append('action', 'register');
            
            if (!formData.get('session')) {
                displayMessage("Error: Please select a show session.", 'error');
                return;
            }

            // Disable UI
            submitButton.disabled = true;
            submitButton.classList.remove('submit-enabled');
            submitButton.classList.add('bg-gray-400');
            loadingSpinner.classList.remove('hidden');
            
            try {
                // Lô-gic đăng ký (register) vẫn sử dụng URL thực (GAS_URL)
                const response = await attemptFetch(GAS_URL, {
                    method: 'POST',
                    body: formData 
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    // 1. Show Success Screen
                    document.getElementById('success-name').textContent = result.fullName;
                    
                    // Lấy giá trị Class từ server (nếu có) hoặc từ input form
                    const finalClassToDisplay = String(result.class || className).toUpperCase();
                    document.getElementById('success-class').textContent = finalClassToDisplay;

                    document.getElementById('success-session').textContent = getSessionTime(result.session);
                    
                    // Hide form elements and show success screen
                    registrationContent.classList.add('hidden');
                    successScreen.classList.remove('hidden');

                    // 2. Fetch new stats in the background (important for capacity check)
                    fetchStats(); 
                } else {
                    // Handle server-side errors
                    const details = result.message || "An unknown error occurred on the server.";
                    displayMessage(`Registration Failed: ${details}`, 'error');
                }

            } catch (error) {
                console.error(error);
                displayMessage(error.message, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
                // Re-enable UI if success screen is not active (i.e., if submission failed)
                if (successScreen.classList.contains('hidden')) {
                    // Cần chạy lại hàm xử lý trạng thái để nút được enable/disable đúng theo giờ thực tế
                    fetchStats(); 
                }
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchStats(); 
            form.addEventListener('submit', handleSubmit);
        });

        // Set interval to refresh stats every 30 seconds
        setInterval(fetchStats, 30000); 

    </script>
</body>
</html>

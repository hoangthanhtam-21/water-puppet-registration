<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Puppet Show: The Legend of Y·∫øt Ki√™u</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for Background Image and Overlay (Original Theme) */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem 0.5rem; 
            
            /* Background Image from user request (Water Puppet Stage) */
            background-image: url('https://livingnomads.com/wp-content/uploads/2017/03/30/hue-water-puppet-show-1068x801.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        
        /* Overlay for better text readability */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.55); /* Dark overlay */
            z-index: -1;
        }

        .container {
            max-width: 600px; 
            width: 100%;
        }
        
        /* Card appearance: slightly translucent white/grey */
        .card {
            background-color: rgba(255, 255, 255, 0.9); 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        /* Header Title Styling (ADJUSTED for full width and 2 lines) */
        .header-title {
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
            color: #fff;
            background-color: rgba(0, 50, 100, 0.7);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            width: 100%; /* Ensure full width */
            max-width: 100%; /* Override previous max-width: 400px; */
            box-sizing: border-box; /* Include padding in width calculation */
        }
        .header-title h1 {
            line-height: 1.1;
        }

        /* Primary Button (Green Accent) */
        .button-primary {
            background-color: #10b981; /* Emerald Green */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: background-color 0.2s;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #059669;
        }

        /* Input Focus (Green Border) */
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: #10b981;
            outline: none;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        
        /* Session Item Styling */
        .session-item {
            cursor: pointer;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .session-item.selected {
            border-color: #10b981; 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
            background-color: #f0fdf4;
        }
        .sold-out {
            background-color: #fef2f2; /* Light Red for sold out */
            color: #991b1b;
            cursor: not-allowed;
            opacity: 0.7;
            pointer-events: none;
            border-color: #fca5a5;
        }
        .session-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        .session-grid > div {
            min-height: 80px; /* Ensure consistent height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* Status Header */
        .status-header {
            background-color: #eff6ff; 
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }

        /* NEW: Style for clickable session labels */
        .session-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid #e5e7eb; /* default border */
            border-radius: 0.5rem;
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%; /* Ensure it fills the space */
            min-height: 50px;
        }
        .session-label:hover:not(.opacity-50) {
            border-color: #a7f3d0;
            background-color: #f7fee7;
        }
        .session-label input[type="radio"] {
            display: none; /* Hide the default radio button */
        }
        .session-label input[type="radio"]:checked + .session-display {
            border-color: #059669; /* Darker green border when checked */
            background-color: #ecfdf5; /* Light green background when checked */
            color: #047857; /* Darker text */
            font-weight: 700;
        }
        .session-display {
            /* This is the visual box that responds to the radio state */
            border: 2px solid transparent; /* Used for visual checked state */
            border-radius: 0.375rem;
            width: 100%;
            text-align: center;
            padding: 0.25rem 0;
            transition: all 0.2s;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Custom styling for the text inside the box */
        .session-time-text {
            letter-spacing: 0.05em; /* tracking-wide equivalent */
            font-size: 1rem; /* text-base equivalent */
            font-weight: 600;
        }
        
        /* --- Style for disabled (FULL) sessions with overlay --- */
        .session-label.opacity-50 {
            background-color: #fef2f2;
            border-color: #fca5a5;
            cursor: not-allowed;
            position: relative; /* Needed for absolute overlay */
            overflow: hidden;
        }
        .session-label.opacity-50 .session-time-text {
            color: #b91c1c;
        }
        /* NEW FULL overlay style */
        .session-label.opacity-50::before {
            content: 'FULL';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem; /* Larger text */
            font-weight: 800;
            color: rgba(220, 38, 38, 0.65); /* Red text, semi-transparent */
            background-color: rgba(255, 255, 255, 0.7); /* Semi-transparent white background */
            pointer-events: none; /* Allows clicks to pass through to the disabled input/label */
            z-index: 10;
            transform: rotate(-5deg); /* Slight rotation for emphasis */
            border-radius: 0.5rem; /* Match the label border radius */
        }

        /* Full-Screen Confirmation Page Overlay */
        #confirmation-screen-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* B·ªé display:flex C·ªê ƒê·ªäNH ·ªû ƒê√ÇY ƒë·ªÉ cho Tailwind's 'hidden' class ho·∫°t ƒë·ªông */
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.75); /* Darker overlay */
            z-index: 50; /* Above all other content */
        }

        /* B·ªï sung: ƒê·∫£m b·∫£o khi kh√¥ng c√≥ l·ªõp 'hidden', n√≥ ph·∫£i l√† flex */
        #confirmation-screen-wrapper:not(.hidden) {
            display: flex;
        }
        
        #confirmation-screen {
            background-color: white;
            max-width: 450px;
            width: 90%;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.5s ease-out;
            text-align: center;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Message Box (Standard) -->
    <div id="message-box" role="alert" style="position: fixed; top: 1rem; right: 1rem; z-index: 1000; padding: 1rem; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: none; opacity: 0; transition: opacity 0.3s ease-in-out;"></div>

    <div class="container" id="main-content">
        
        <!-- HEADER TITLE SECTION -->
        <div class="header-title text-center mx-auto">
            <p class="text-xs font-semibold uppercase text-red-300 tracking-wider mb-1">EXCLUSIVE SHOW</p>
            <h1 class="text-4xl font-black tracking-tight text-yellow-500">
                WATER PUPPET SHOW: <br>THE LEGEND OF Y·∫æT KI√äU
            </h1>
            <p class="text-sm font-medium text-gray-200 mt-1">
                The story of one of the five brilliant commanders of H∆∞ng ƒê·∫°o V∆∞∆°ng.
            </p>
        </div>

        <!-- KEY DETAILS SECTION -->
        <div class="card space-y-3">
            <h2 class="text-lg font-bold text-gray-800 flex items-center mb-3">
                <span class="text-green-600 mr-2">‚úÖ</span> Key Details
            </h2>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <div class="font-bold text-gray-700">Organizers:</div>
                <div class="text-right">Nguyen Khuyen English Dept. & HCMC Center of Arts</div>
                
                <div class="font-bold text-gray-700">Time:</div>
                <div class="text-right text-red-600 font-bold">October 18, 2025</div>
                
                <div class="font-bold text-gray-700">Price:</div>
                <div class="text-right text-green-600 font-bold">80,000 VND/ticket</div>
                
                <div class="font-bold text-gray-700">Location:</div>
                <div class="text-right text-sm text-gray-600">Water Puppet Stage ‚Äì No. 2 Nguyen Binh Khiem, HCMC (Inside the History Museum)</div>
            </div>
        </div>

        <!-- IMPORTANT NOTICE SECTION -->
        <div class="card bg-red-50 border-l-4 border-red-500">
            <h3 class="text-lg font-bold text-red-700 flex items-center mb-2">
                <span class="text-xl mr-2">‚ùóÔ∏è</span> Important Notice
            </h3>
            <ul class="text-sm text-gray-700 list-disc pl-5 space-y-2">
                <li>Each student can only register for <strong>1 ticket</strong>.</li>
                <li>Show is exclusively for <strong>10th-grade students</strong> of Nguyen Khuyen High School.</li>
                <li>Deadline: <strong>23:59 on Oct 7, 2025</strong> or when <strong>130 seats/session</strong> are filled.</li>
            </ul>
        </div>
        
        <!-- REGISTRATION STATUS -->
        <div class="card p-0 overflow-hidden">
            <div id="registration-status-box" class="status-header p-4 text-center rounded-t-lg">
                <p class="text-lg font-extrabold" id="status-message">LOADING REGISTRATION STATUS...</p>
                <p class="text-sm font-normal mt-1" id="countdown-timer">Checking form availability...</p>
            </div>
        </div>

        <!-- SESSION AVAILABILITY STATUS (Full session times in titles) -->
        <div class="card">
            <h2 class="text-lg font-bold text-gray-800 mb-4 text-center">
                Session Availability Status
            </h2>
            <div id="stats-container" class="session-grid">
                <p class="col-span-3 text-center text-gray-500 italic">Loading data...</p>
            </div>
        </div>
            
        <!-- TICKET REGISTRATION FORM -->
        <div class="card" id="registration-card"> 
            <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center border-b pb-2">
                <span class="text-green-600 mr-2">üéüÔ∏è</span> Ticket Registration (Max 1)
            </h2>

            <form id="registration-form" class="space-y-5">
                <!-- Student Info -->
                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required class="input-field" placeholder="E.g., Nguyen Van A">
                </div>

                <div>
                    <label for="class" class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                    <input type="text" id="class" name="class" required class="input-field" pattern="^10[a-zA-Z0-9-]+" title="Class must start with '10'" placeholder="e.g., 10A1, 10B2">
                    <p class="text-xs text-red-500 mt-1" id="class-error-message" style="display: none;">Validation Error: Only Grade 10 students are eligible (Class must start with '10').</p>
                </div>

                <!-- Session Selection (Radio Buttons - ADJUSTED FOR FRAME AND BOLDING) -->
                <div class="pt-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Session</label>
                    <div id="session-radio-buttons" class="flex justify-around items-center gap-2"> 
                        
                        <label class="session-label flex-1 text-gray-700 text-sm">
                            <input type="radio" name="sessionRadio" value="Session 1: 8:00-9:00">
                            <div class="session-display">
                                <span class="session-time-text">8:00-9:00</span>
                            </div>
                        </label>
                        
                        <label class="session-label flex-1 text-gray-700 text-sm">
                            <input type="radio" name="sessionRadio" value="Session 2: 13:00-14:00">
                            <div class="session-display">
                                <span class="session-time-text">13:00-14:00</span>
                            </div>
                        </label>
                        
                        <label class="session-label flex-1 text-gray-700 text-sm">
                            <input type="radio" name="sessionRadio" value="Session 3: 16:00-17:00">
                            <div class="session-display">
                                <span class="session-time-text">16:00-17:00</span>
                            </div>
                        </label>
                    </div>
                    <input type="hidden" id="selectedSession" name="session" required>
                </div>

                <div class="pt-4">
                    <!-- Button is disabled initially and enabled by JS/GAS check -->
                    <button type="submit" id="submit-button" class="button-primary w-full text-lg hover:shadow-lg opacity-50 cursor-not-allowed" disabled>
                        Loading Status...
                    </button>
                </div>
            </form>
        </div>
        
    </div>
    
    <!-- Full-Screen Confirmation Page Wrapper -->
    <!-- ƒê√É TH√äM class="hidden" V√ÄO TR·∫†NG TH√ÅI KH·ªûI T·∫†O -->
    <div id="confirmation-screen-wrapper" class="hidden"> 
        <div id="confirmation-screen" class="shadow-2xl">
            <img src="https://newsmd2fr.keeng.vn/tiin/archive/imageslead/2024/12/24/6ljali0161btgdnu4mq8w9wkyiacshg7.jpg" 
                    onerror="this.onerror=null;this.src='https://placehold.co/300x200/10b981/ffffff?text=SUCCESS!';" 
                    alt="Cheerful confirmation image" 
                    class="mx-auto h-32 w-auto object-cover rounded-lg shadow-xl mb-4">
            
            <h2 class="text-3xl font-bold text-gray-900 mt-4 text-emerald-600">CONGRATULATIONS!</h2>
            <h3 class="text-xl font-semibold text-gray-700 mt-1">Registration Successful!</h3>
            
            <div class="mt-6 bg-emerald-50 p-4 rounded-lg shadow-inner text-left border-l-4 border-emerald-500">
                <p class="text-lg font-semibold text-gray-800">Your Registration Details:</p>
                <p class="mt-1 text-gray-700"><strong>Full Name:</strong> <span id="conf-fullName" class="font-medium"></span></p>
                <p class="text-gray-700"><strong>Class:</strong> <span id="conf-class" class="font-medium"></span></p>
                <p class="text-gray-700"><strong>Session:</strong> <span id="conf-session" class="font-medium"></span></p>
                
                <p class="text-sm mt-3 text-red-700 font-bold">
                    Please wait for the official list and prepare 80,000 VND for payment.
                </p>
            </div>
        </div>
    </div>


    <script>
        // !! B∆Ø·ªöC QUAN TR·ªåNG: ƒê√É THAY TH·∫æ B·∫∞NG WEB APP URL M·ªöI C·ª¶A B·∫†N !!
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwjFfaVEoJHsfkh_hcK1hK9U4VGEBT4p72PIm1cJHpiENA5o--QFeXJNe38B2-yHhui/exec'; 

        // Configuration (MUST match GAS settings)
        const SESSION_NAMES = ["Session 1: 8:00-9:00", "Session 2: 13:00-14:00", "Session 3: 16:00-17:00"];
        
        // DOM Elements
        const form = document.getElementById('registration-form');
        const mainContent = document.getElementById('main-content');
        const statsContainer = document.getElementById('stats-container');
        const selectedSessionInput = document.getElementById('selectedSession');
        const sessionRadioButtons = document.getElementById('session-radio-buttons');
        const statusMessage = document.getElementById('status-message');
        const countdownTimer = document.getElementById('countdown-timer');
        const submitButton = document.getElementById('submit-button');
        const classInput = document.getElementById('class');
        const classErrorMessage = document.getElementById('class-error-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageBox = document.getElementById('message-box');
        const confirmationWrapper = document.getElementById('confirmation-screen-wrapper');
        const statusHeaderBox = document.getElementById('registration-status-box');

        let maxCapacity = 130;
        let countdownInterval; // Bi·∫øn l∆∞u tr·ªØ ID c·ªßa interval ƒë·∫øm ng∆∞·ª£c

        // --- UTILITY FUNCTIONS ---

        function showMessage(type, message) {
            messageBox.textContent = message;
            messageBox.className = ''; 
            messageBox.classList.add(type, 'text-white');
            if (type === 'success') messageBox.style.backgroundColor = '#10b981';
            if (type === 'error') messageBox.style.backgroundColor = '#ef4444';

            messageBox.style.opacity = 1;
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.style.opacity = 0;
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 300);
            }, 5000);
        }

        function toggleLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        /**
         * Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng JS th√†nh chu·ªói query URL.
         * @param {object} params - Tham s·ªë.
         * @returns {string} Chu·ªói query.
         */
        function encodeData(params) {
            return Object.keys(params)
                .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                .join('&');
        }
        
        // H√†m ƒë·ªãnh d·∫°ng s·ªë v·ªÅ 2 ch·ªØ s·ªë (v√≠ d·ª•: 5 -> 05)
        const pad = (n) => (n < 10 ? '0' + n : n);

        /**
         * B·∫Øt ƒë·∫ßu b·ªô ƒë·∫øm ng∆∞·ª£c th·ªùi gian m·ªü form.
         * @param {number} startTimestamp - Th·ªùi gian form s·∫Ω m·ªü (miligi√¢y).
         */
        function startCountdown(startTimestamp) {
            // X√≥a b·ªô ƒë·∫øm c≈© n·∫øu c√≥
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            const updateTimer = () => {
                const now = new Date().getTime();
                const diff = startTimestamp - now;

                if (diff <= 0) {
                    clearInterval(countdownInterval);
                    statusMessage.textContent = "REGISTRATION IS OPENING NOW...";
                    countdownTimer.textContent = "Refreshing status...";
                    // T·ª± ƒë·ªông t·∫£i l·∫°i tr·∫°ng th√°i form khi h·∫øt gi·ªù
                    fetchStats(); 
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                let timeString = '';
                if (days > 0) {
                    timeString += `${days} days, `;
                }
                timeString += `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

                countdownTimer.textContent = `Time remaining until open: ${timeString}`;
            };

            // Ch·∫°y l·∫ßn ƒë·∫ßu ti√™n v√† sau ƒë√≥ m·ªói gi√¢y
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        /**
         * L·∫•y d·ªØ li·ªáu t·ª´ Google Apps Script (S·ª≠ d·ª•ng doGet).
         */
        async function fetchStats() {
            if (GAS_WEB_APP_URL.includes('PASTE_YOUR_GAS_WEB_APP_URL_HERE')) {
                console.error("VUI L√íNG THAY TH·∫æ GAS_WEB_APP_URL B·∫∞NG URL WEB APP C·ª¶A B·∫†N.");
                showMessage('error', 'C·∫£nh b√°o: Vui l√≤ng d√°n Web App URL c·ªßa b·∫°n ƒë·ªÉ k√≠ch ho·∫°t ch·ª©c nƒÉng.');
                // M√¥ ph·ªèng d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã giao di·ªán khi l·ªói config
                renderStats({ "Session 1: 8:00-9:00": 120, "Session 2: 13:00-14:00": 80, "Session 3: 16:00-17:00": 130 }, 130);
                return;
            }
            
            try {
                const response = await fetch(GAS_WEB_APP_URL, { method: 'GET' });
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    maxCapacity = data.maxCapacity;

                    renderStats(data.stats, data.maxCapacity);
                    checkRegistrationStatus(data.formStatus, data.startTime, data.endTime);
                } else {
                    showMessage('error', `L·ªói t·∫£i th·ªëng k√™: ${result.details}`);
                }
            } catch (error) {
                console.error("L·ªói khi k·∫øt n·ªëi v·ªõi GAS:", error);
                showMessage('error', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi h·ªá th·ªëng th·ªëng k√™. Vui l√≤ng ki·ªÉm tra l·∫°i URL.');
            }
        }

        /**
         * Hi·ªÉn th·ªã s·ªë li·ªáu th·ªëng k√™ v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t radio.
         */
        function renderStats(stats, capacity) {
            let html = '';
            
            SESSION_NAMES.forEach(session => {
                const registered = stats[session] || 0;
                const remaining = Math.max(0, capacity - registered);
                const isFull = remaining === 0;
                
                // Colors based on availability
                const bgColor = isFull ? 'bg-red-100' : 'bg-gray-100';
                const textColor = isFull ? 'text-red-700' : 'text-gray-700';
                const numberColor = isFull ? 'text-red-600' : 'text-green-600';
                const sessionTime = session.split(': ')[1].trim(); // Get the time part only

                html += `
                    <div class="p-3 rounded-lg ${bgColor} text-sm shadow-sm">
                        <p class="font-bold text-base text-gray-800">${sessionTime}</p> 
                        <p class="text-xs ${textColor} mt-1">
                            <span class="font-bold ${numberColor}">${registered}</span> Registered
                        </p>
                        <p class="text-xs text-gray-500 mt-0.5">
                            Capacity / <span class="font-bold text-red-600">${capacity}</span>
                        </p>
                    </div>
                `;
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i radio button tr√™n form
                const radio = sessionRadioButtons.querySelector(`input[value="${session}"]`);
                if (radio) {
                    radio.disabled = isFull;
                    const parentLabel = radio.closest('.session-label');
                    if (parentLabel) {
                        parentLabel.classList.toggle('opacity-50', isFull); 
                        parentLabel.classList.toggle('cursor-not-allowed', isFull);
                        
                        // N·∫øu su·∫•t ƒë√£ ƒë·∫ßy, h·ªßy ch·ªçn n·∫øu h·ªçc sinh ƒë√£ ch·ªçn tr∆∞·ªõc ƒë√≥
                        if (isFull && radio.checked) {
                            radio.checked = false;
                            selectedSessionInput.value = '';
                        }
                    }
                }
            });

            statsContainer.innerHTML = html;
        }

        /**
         * Ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªü/ƒë√≥ng c·ªßa form.
         */
        function checkRegistrationStatus(status, startTimestamp, endTimestamp) {
            // ƒê·∫£m b·∫£o d·ª´ng m·ªçi b·ªô ƒë·∫øm c≈©
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // Format ng√†y gi·ªù hi·ªÉn th·ªã
            const formatTime = (date) => new Date(date).toLocaleString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit', 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            }).replace(',', '');

            submitButton.disabled = true;
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');

            if (status === "OPEN") {
                statusMessage.textContent = "REGISTRATION IS OPEN NOW";
                countdownTimer.classList.remove('hidden');
                countdownTimer.textContent = `Form closes at: ${formatTime(endTimestamp)}`;
                statusHeaderBox.className = 'p-4 text-center rounded-t-lg bg-green-100 text-green-700';
                
                // K√≠ch ho·∫°t n√∫t submit
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitButton.textContent = "Submit Registration";
            } else if (status === "NOT_OPEN") {
                statusMessage.textContent = "REGISTRATION IS NOT OPEN YET";
                countdownTimer.classList.remove('hidden');
                
                // K√≠ch ho·∫°t b·ªô ƒë·∫øm ng∆∞·ª£c
                startCountdown(startTimestamp);
                
                statusHeaderBox.className = 'p-4 text-center rounded-t-lg bg-yellow-100 text-yellow-700';
                submitButton.textContent = "Registration Not Open Yet";

            } else { // CLOSED
                statusMessage.textContent = "REGISTRATION HAS ENDED";
                countdownTimer.classList.add('hidden');
                statusHeaderBox.className = 'p-4 text-center rounded-t-lg bg-red-100 text-red-700';
                submitButton.textContent = "Registration Closed";
            }
        }

        // --- EVENT LISTENERS ---

        // Update hidden input when a radio button is selected
        sessionRadioButtons.addEventListener('change', (e) => {
            if (e.target.name === 'sessionRadio' && !e.target.disabled) {
                selectedSessionInput.value = e.target.value;
            }
        });

        // Form Submission Handler (S·ª≠ d·ª•ng doPost)
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // 1. Client-side validation
            if (!classInput.value.match(/^10[a-zA-Z0-9-]+/)) {
                classErrorMessage.style.display = 'block';
                showMessage('error', 'Validation Error: Only Grade 10 students are eligible (Class must start with "10").');
                return;
            } else {
                classErrorMessage.style.display = 'none';
            }
            
            if (!selectedSessionInput.value) {
                showMessage('error', 'Please select a session before submitting.');
                return;
            }

            toggleLoading(true);

            // 2. Prepare data for POST request
            const formData = {
                fullName: document.getElementById('fullName').value.trim(),
                class: document.getElementById('class').value.trim(),
                session: selectedSessionInput.value,
            };

            try {
                // Post data to GAS (Web App URL)
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    // ƒê·∫£m b·∫£o d·ªØ li·ªáu ƒë∆∞·ª£c g·ª≠i d∆∞·ªõi d·∫°ng x-www-form-urlencoded
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: encodeData(formData)
                });
                
                const result = await response.json();

                if (result.success) {
                    // 3. ƒêƒÉng k√Ω th√†nh c√¥ng: Chuy·ªÉn sang trang ch√∫c m·ª´ng
                    const registeredData = result.data;
                    document.getElementById('conf-fullName').textContent = registeredData.fullName; // T√™n ƒë√£ ƒë∆∞·ª£c Title Case t·ª´ GAS
                    document.getElementById('conf-class').textContent = registeredData.className;     // L·ªõp ƒë√£ ƒë∆∞·ª£c vi·∫øt hoa t·ª´ GAS
                    document.getElementById('conf-session').textContent = registeredData.selectedSession;
                    
                    showMessage('success', result.message);
                    
                    // ·∫®N MAIN CONTENT v√† HI·ªÇN TH·ªä FULL-SCREEN CONFIRMATION
                    mainContent.classList.add('hidden');
                    confirmationWrapper.classList.remove('hidden');
                    confirmationWrapper.classList.add('flex'); // Hi·ªÉn th·ªã m√†n h√¨nh x√°c nh·∫≠n

                    // C·∫≠p nh·∫≠t th·ªëng k√™ ngay l·∫≠p t·ª©c (d√π ƒëang ·ªü trang ch√∫c m·ª´ng)
                    fetchStats(); 
                } else {
                    // 4. ƒêƒÉng k√Ω th·∫•t b·∫°i (Tr√πng l·∫∑p, h·∫øt ch·ªó, ho·∫∑c form ƒë√≥ng)
                    showMessage('error', result.details);
                }

            } catch (error) {
                console.error("L·ªói g·ª≠i form ƒë·∫øn GAS:", error);
                showMessage('error', 'L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c Web App URL.');
            } finally {
                toggleLoading(false);
            }
        });
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // L·∫•y th·ªëng k√™ v√† tr·∫°ng th√°i form ngay khi t·∫£i trang v√† m·ªói 30 gi√¢y
            fetchStats(); 
            // V·∫´n gi·ªØ interval 30s ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë li·ªáu th·ªëng k√™ chung
            setInterval(fetchStats, 30000); 
        });
    </script>
</body>
</html>
